!======================================================================!
program sucrose
!----------------------------------------------------------------------!
implicit none
!----------------------------------------------------------------------!
character (len =   4) :: fid ! For output filename
character (len = 200) :: filename ! Ouput filename
real :: KSu
real :: n
real :: alpha
real :: beta
real :: dt
real :: M
real :: fSu
real :: Su
integer :: i, j
!----------------------------------------------------------------------!
write (*,*) 'Sucrose is running...'
!----------------------------------------------------------------------!
! Run to test convergence (Fig. 2).
! Loop over different initial sucrose fractions.
!----------------------------------------------------------------------!
! Neutral sucrose fraction                               (fraction of M)
!----------------------------------------------------------------------!
KSu   = 0.028
!----------------------------------------------------------------------!
! Hill coefficient                                            (unitless)
!----------------------------------------------------------------------!
n     = 4.0
!----------------------------------------------------------------------!
! Potential rate of photosynthesis                       (kg{Su}/m2/day)
!----------------------------------------------------------------------!
alpha = 13.14e-3
!----------------------------------------------------------------------!
! Potential rate of growth                               (kg{Su}/m2/day)
!----------------------------------------------------------------------!
beta  = 13.14e-3
!----------------------------------------------------------------------!
! Timestep                                                         (day)
!----------------------------------------------------------------------!
dt    = 1.0
!----------------------------------------------------------------------!
! Structural mass                                            (kg(DM)/m2)
!----------------------------------------------------------------------!
M     = 48.1
!----------------------------------------------------------------------!
! Initial sucrose mass                                       (kg(Su)/m2)
!----------------------------------------------------------------------!
Su    = 0.0
!----------------------------------------------------------------------!
! Sucrose fraction                                       (fraction of M)
!----------------------------------------------------------------------!
fSu   = Su / M
!----------------------------------------------------------------------!
! Loop over initial Su values for Figure 1.
!----------------------------------------------------------------------!
do j = 1, 11
  !--------------------------------------------------------------------!
  ! Set string to convergence number.
  !--------------------------------------------------------------------!
  write (fid, '(i4)') j
  if (j > 999) then
    fid = fid
  else if (j > 99) then
    fid (1:1) = '0'
  else if (j > 9) then
    fid (1:2) = '00'
  else
    fid (1:3) = '000'
  end if
  !--------------------------------------------------------------------!
  filename = 'OUTPUT/diag_'//fid//'.txt'
  write (*,*) 'Opening ',trim(filename)
  open (20, file = filename, status = "unknown")
  write (20,*) '0', fSu
  !--------------------------------------------------------------------!
  ! Loop over timesteps (days)
  !--------------------------------------------------------------------!
  do i = 1, 400
    !------------------------------------------------------------------!
    ! Advance state variables one timestep.
    !------------------------------------------------------------------!
    call advance (KSu, n, alpha, beta, dt, M, fSu, Su)
    !------------------------------------------------------------------!
    ! Write output for Figure 2.
    !------------------------------------------------------------------!
    write (20,*) i, fSu
    !------------------------------------------------------------------!
  end do
  !--------------------------------------------------------------------!
  close (20)
  !--------------------------------------------------------------------!
  Su = M * float (j) * 0.00576
  fSu = Su / M
  !--------------------------------------------------------------------!
end do ! j = 1, 11
!----------------------------------------------------------------------!
! Run to test response to changing potential source rate.
!----------------------------------------------------------------------!
alpha = 1.0e-6
do j = 1, 201
end do ! j = 1, 201
!----------------------------------------------------------------------!
write (*,*) 'Sucrose has finished...'
!----------------------------------------------------------------------!
end program sucrose
!======================================================================!
subroutine advance (KSu, n, alpha, beta, dt, M, fSu, Su)
!----------------------------------------------------------------------!
! Advance state variables one timestep.
!----------------------------------------------------------------------!
implicit none
!----------------------------------------------------------------------!
real, intent(in) :: KSu
real, intent(in) :: n
real, intent(in) :: alpha
real, intent(in) :: beta
real, intent(in) :: dt
real, intent(in) :: M
real, intent(inout) :: fSu
real, intent(inout) :: Su
real :: fa
real :: fi
real :: qin
real :: qout
real :: dSu
!----------------------------------------------------------------------!
! Activation factor; Eqn. (2)                         (Eqn. (2); scalar)
!----------------------------------------------------------------------!
fa = (fSu ** n) / (KSu ** n + fSu ** n)
!----------------------------------------------------------------------!
! Inhibition factor; Eqn. (3)                                   (scaler)
!----------------------------------------------------------------------!
fi = (KSu ** n) / (KSu ** n + fSu ** n)
!----------------------------------------------------------------------!
! C source flux; Eqn. (4)                                (kg(Su)/m2/day)
!----------------------------------------------------------------------!
qin  = fi * alpha
!----------------------------------------------------------------------!
! C sink flux Eqn. (4)                                   (kg(Su)/m2/day)
!----------------------------------------------------------------------!
qout = fa * beta
!----------------------------------------------------------------------!
! Change in sucrose C mass; Eqn. (1)                     (kg(Su)/m2/day)
!----------------------------------------------------------------------!
dSu = qin - qout
!----------------------------------------------------------------------!
! Integrate Su                                               (kg(Su)/m2)
!----------------------------------------------------------------------!
Su = Su + dt * dSu
!----------------------------------------------------------------------!
! New sucrose fraction                                        (fraction)
!----------------------------------------------------------------------!
fSu = Su / M
!----------------------------------------------------------------------!
end subroutine advance
!======================================================================!
